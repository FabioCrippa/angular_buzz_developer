rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===============================================
    // ÔøΩ FUN√á√ïES AUXILIARES
    // ===============================================
    
    // Verifica se o usu√°rio est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica se o usu√°rio √© o dono do recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Valida campos obrigat√≥rios do usu√°rio
    function hasValidUserFields() {
      return request.resource.data.keys().hasAll(['email', 'name', 'isPremium'])
        && request.resource.data.email is string
        && request.resource.data.name is string
        && request.resource.data.isPremium is bool;
    }
    
    // ===============================================
    // üë§ COLE√á√ÉO DE USU√ÅRIOS
    // ===============================================
    match /users/{userId} {
      // Leitura: apenas pr√≥prio usu√°rio
      allow read: if isOwner(userId);
      
      // Cria√ß√£o: permitir durante cadastro com valida√ß√£o
      allow create: if isOwner(userId) && hasValidUserFields();
      
      // Atualiza√ß√£o: apenas pr√≥prio usu√°rio, mas n√£o pode alterar isPremium diretamente
      allow update: if isOwner(userId) 
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isPremium', 'subscriptionId', 'premiumExpiresAt'])
        || request.resource.data.isPremium == resource.data.isPremium);
      
      // Dele√ß√£o: apenas pr√≥prio usu√°rio
      allow delete: if isOwner(userId);
      
      // ===============================================
      // üìä SUBCOLE√á√ÉO: PROGRESSO
      // ===============================================
      match /progress/{areaId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
      
      // ===============================================
      // üìö SUBCOLE√á√ÉO: HIST√ìRICO DE QUIZZES
      // ===============================================
      match /quizHistory/{quizId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId)
          && request.resource.data.keys().hasAll(['areaId', 'score', 'totalQuestions', 'completedAt'])
          && request.resource.data.score >= 0
          && request.resource.data.totalQuestions > 0;
        allow update, delete: if isOwner(userId);
      }
      
      // ===============================================
      // ‚≠ê SUBCOLE√á√ÉO: FAVORITOS
      // ===============================================
      match /favorites/{questionId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // ===============================================
    // üí≥ COLE√á√ÉO DE ASSINATURAS
    // ===============================================
    match /subscriptions/{subscriptionId} {
      // Leitura: apenas dono da assinatura
      allow read: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // Escrita: APENAS backend (Firebase Admin SDK)
      allow write: if false;
    }
    
    // ===============================================
    // üö´ NEGAR ACESSO A OUTRAS COLE√á√ïES
    // ===============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
