<!--
  Container principal do quiz. Utiliza uma classe para facilitar a estilização e garantir responsividade.
-->
<div class="quiz-container">
  <!-- ✅ LOADING STATE -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">
      <div class="spinner-ring"></div>
    </div>
    <h3>Preparando seu quiz...</h3>
    <p>{{ loadingMessage || 'Carregando questões incríveis para você!' }}</p>
    <div class="loading-progress" *ngIf="loadingProgress">
      <div class="loading-bar" [style.width.%]="loadingProgress"></div>
      <span>{{ loadingProgress }}%</span>
    </div>
  </div>

  <!-- ✅ ERROR STATE -->
  <div *ngIf="hasError" class="error-container">
    <div class="error-content">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Erro ao carregar questões</h3>
      <p>{{ errorMessage }}</p>
      <button class="btn btn-primary" (click)="reloadQuestions()">
        <i class="fas fa-refresh"></i>
        Tentar Novamente
      </button>
    </div>
  </div>

  <!-- ✅ QUIZ ACTIVE STATE -->
  <div *ngIf="!isLoading && !hasError && !quizCompleted && currentQuestion" class="quiz-active">
    
    <!-- ✅ HEADER -->
    <div class="quiz-header">
      <div class="quiz-info">
        <h1>{{ title }}</h1>
        <div class="question-counter">
          <span class="current">{{ currentQuestionIndex + 1 }}</span>
          <span class="separator">de</span>
          <span class="total">{{ totalQuestions }}</span>
        </div>
      </div>
      
      <!-- ✅ PROGRESS BAR -->
      <div class="progress-container">
        <div class="progress-bar" 
             role="progressbar"
             [attr.aria-valuenow]="progressPercentageRounded"
             aria-valuemin="0" 
             aria-valuemax="100"
             [attr.aria-label]="progressAriaLabel">
          <div class="progress-fill" [style.width.%]="progressPercentage"></div>
        </div>
        <span class="progress-text">{{ progressPercentageRounded }}%</span>
      </div>
    </div>

    <!-- ✅ QUIZ STATS - APENAS UMA VEZ -->
    <div class="quiz-stats" 
         [class.mobile-view]="isMobile()"
         [class.tablet-view]="isTablet()">
      <div class="stat-item">
        <div class="stat-value">{{ currentQuestionIndex + 1 }}</div>
        <div class="stat-label">Questão</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ correctAnswers }}</div>
        <div class="stat-label">Acertos</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ getTimeSpentFormatted() }}</div>
        <div class="stat-label">Tempo</div>
      </div>
      <div class="stat-item">
        <button mat-icon-button (click)="toggleFavorite()" 
                [color]="isFavorite() ? 'accent' : ''" 
                title="Favoritar questão">
          <mat-icon>{{ isFavorite() ? 'favorite' : 'favorite_border' }}</mat-icon>
        </button>
      </div>
      <div class="stat-item">
        <button mat-icon-button (click)="pauseQuiz()" 
                [title]="isPaused ? 'Continuar' : 'Pausar'">
          <mat-icon>{{ isPaused ? 'play_arrow' : 'pause' }}</mat-icon>
        </button>
      </div>
    </div>

    <!-- ✅ PAUSE OVERLAY -->
    <div class="pause-overlay" *ngIf="isPaused">
      <div class="pause-card">
        <mat-icon style="font-size: 3rem; color: #667eea;">pause_circle_filled</mat-icon>
        <h2>Quiz Pausado</h2>
        <p>Clique em continuar quando estiver pronto</p>
        <button mat-raised-button color="primary" (click)="pauseQuiz()">
          <mat-icon>play_arrow</mat-icon>
          Continuar
        </button>
      </div>
    </div>

    <!-- ✅ QUESTION CONTENT -->
    <div class="question-container">
      <div class="question-header">
        <h2 class="question-text">{{ currentQuestion.question }}</h2>
        
        <!-- ✅ QUESTION META INFO -->
        <div class="question-meta" *ngIf="currentQuestion.difficulty || currentQuestion.category">
          <span class="difficulty-tag" *ngIf="currentQuestion.difficulty">
            {{ currentQuestion.difficulty }}
          </span>
          <span class="category-tag" *ngIf="currentQuestion.category">
            {{ getCategoryTitle(currentQuestion.category) }}
          </span>
        </div>
      </div>

      <!-- ✅ OPTIONS LIST - MODO NORMAL -->
      <div class="options-container" *ngIf="!showExplanation">
        <div 
          class="option-item"
          *ngFor="let option of currentQuestion.options; let i = index"
          [class.selected]="selectedAnswer === option.alias"
          [class.disabled]="showExplanation"
          (click)="!showExplanation && selectAnswer(option.alias)"
          (keydown)="handleOptionKeydown($event, option.alias, i)"
          role="button"
          tabindex="0"
          [attr.aria-pressed]="selectedAnswer === option.alias"
          [attr.aria-label]="'Opção ' + getOptionLetter(i) + ': ' + option.name"
          [attr.aria-disabled]="showExplanation">
          
          <div class="option-letter">{{ getOptionLetter(i) }}</div>
          <div class="option-content">
            <span class="option-text">{{ option.name }}</span>
          </div>
        </div>
      </div>

      <!-- ✅ OPTIONS LIST - MODO EXPLICAÇÃO -->
      <div class="options-container explanation-mode" *ngIf="showExplanation">
        <div 
          class="option-item"
          *ngFor="let option of currentQuestion.options; let i = index"
          [class.selected]="selectedAnswer === option.alias"
          [class.correct]="option.alias === currentQuestion.correct"
          [class.incorrect]="selectedAnswer === option.alias && option.alias !== currentQuestion.correct"
          [class.disabled]="true"
        >
          <div class="option-letter">{{ getOptionLetter(i) }}</div>
          <div class="option-content">
            <span class="option-text">{{ option.name }}</span>
            
            <!-- ✅ FEEDBACK ICONS -->
            <div class="option-feedback">
              <i class="fas fa-check-circle correct-icon" 
                 *ngIf="option.alias === currentQuestion.correct"></i>
              <i class="fas fa-times-circle incorrect-icon" 
                 *ngIf="selectedAnswer === option.alias && option.alias !== currentQuestion.correct"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ EXPLANATION SECTION -->
      <div class="explanation-container" *ngIf="showExplanation && currentQuestion.explanation">
        <div class="explanation-header">
          <i class="fas fa-lightbulb"></i>
          <h3>Explicação</h3>
        </div>
        <div class="explanation-content">
          <p>{{ currentQuestion.explanation }}</p>
          
          <!-- ✅ ADDITIONAL TIPS -->
          <div class="tips-container" *ngIf="currentQuestion.studyTip || currentQuestion.examTip || currentQuestion.interviewTip">
            <div class="tip-item" *ngIf="currentQuestion.studyTip">
              <i class="fas fa-book"></i>
              <span>{{ currentQuestion.studyTip }}</span>
            </div>
            <div class="tip-item" *ngIf="currentQuestion.examTip">
              <i class="fas fa-graduation-cap"></i>
              <span>{{ currentQuestion.examTip }}</span>
            </div>
            <div class="tip-item" *ngIf="currentQuestion.interviewTip">
              <i class="fas fa-handshake"></i>
              <span>{{ currentQuestion.interviewTip }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ ACTION BUTTONS -->
    <div class="quiz-actions">
      
      <!-- ✅ SUBMIT ANSWER BUTTON -->
      <button 
        class="btn btn-primary btn-large"
        *ngIf="selectedAnswer && !showExplanation"
        (click)="submitAnswer()"
        [attr.data-analytics]="'quiz-submit-answer'"
        [attr.data-question-id]="currentQuestion.id">
        <i class="fas fa-check"></i>
        Confirmar Resposta
      </button>

      <!-- ✅ SELECT ANSWER MESSAGE -->
      <div class="select-message" *ngIf="!selectedAnswer && !showExplanation">
        <span>Selecione uma alternativa para continuar</span>
      </div>

      <!-- ✅ NAVIGATION BUTTONS -->
      <div class="navigation-buttons" *ngIf="showExplanation">
        
        <!-- ✅ PREVIOUS BUTTON -->
        <button 
          class="btn btn-secondary"
          *ngIf="canGoPrevious"
          (click)="previousQuestion()"
        >
          <i class="fas fa-arrow-left"></i>
          Anterior
        </button>

        <!-- ✅ NEXT BUTTON -->
        <button 
          class="btn btn-primary"
          *ngIf="canGoNext"
          (click)="nextQuestion()"
        >
          Próxima
          <i class="fas fa-arrow-right"></i>
        </button>

        <!-- ✅ FINISH BUTTON -->
        <button 
          class="btn btn-success btn-large"
          *ngIf="!canGoNext"
          (click)="completeQuiz()"
        >
          <i class="fas fa-flag-checkered"></i>
          Finalizar Quiz
        </button>
      </div>
    </div>

    <!-- ✅ TRIAL WARNING -->
    <div class="trial-warning" *ngIf="isFreeTrial && showTrialWarning">
      <div class="trial-card">
        <i class="fas fa-gift"></i>
        <div class="trial-content">
          <h4>Plano Gratuito</h4>
          <p>{{ trialMessage }}</p>
          <!-- ✅ MOSTRAR OUTRAS ÁREAS DISPONÍVEIS SE HOUVER -->
          <div class="available-areas" *ngIf="hasOtherAreasAvailable()">
            <small>
              <strong>Áreas ainda disponíveis:</strong> 
              {{ getAvailableAreasFormatted() }}
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ QUIZ COMPLETED STATE -->
  <div *ngIf="!isLoading && !hasError && quizCompleted" class="quiz-completed">
    <div class="results-container">
      <div class="results-header">
        <i class="fas fa-trophy"></i>
        <h2>Quiz Concluído!</h2>
      </div>
      
      <div class="score-display">
        <div class="score-circle">
          <span class="score-value">{{ score }}%</span>
        </div>
        <div class="score-details">
          <p><strong>{{ correctAnswers }}</strong> de <strong>{{ totalQuestions }}</strong> questões corretas</p>
          <p>Tempo: <strong>{{ getFinalTimeFormatted() }}</strong></p>
          
          <!-- ✅ INFO DO TRIAL -->
          <div class="trial-info" *ngIf="isFreeTrial">
            <p class="trial-status">
              <i class="fas fa-gift"></i>
              Tentativas restantes em {{ getCategoryTitle(area || 'desenvolvimento-web') }}: 
              <strong>{{ getCurrentAreaRemainingAttempts() }}</strong>
            </p>
            
            <!-- ✅ MOSTRAR TOTAL DE TENTATIVAS RESTANTES -->
            <p class="trial-total" *ngIf="getTotalRemainingAttempts() > 0">
              <i class="fas fa-chart-bar"></i>
              Total de tentativas hoje: <strong>{{ getTotalRemainingAttempts() }}</strong>
            </p>
            
            <!-- ✅ MENSAGEM QUANDO TODAS ESGOTADAS -->
            <p class="trial-exhausted" *ngIf="getTotalRemainingAttempts() === 0">
              <i class="fas fa-clock"></i>
              Todas as tentativas foram utilizadas. Elas serão renovadas automaticamente à meia-noite.
            </p>
          </div>
        </div>
      </div>

      <div class="results-actions">
        <button class="btn btn-primary" 
                (click)="restartQuiz()"
                [disabled]="isRestarting || (isFreeTrial && !canStartQuizInArea(area || 'desenvolvimento-web'))">
          <i class="fas" 
             [class.fa-redo]="!isRestarting" 
             [class.fa-spinner]="isRestarting"
             [class.fa-spin]="isRestarting"></i>
          {{ isRestarting ? 'Reiniciando...' : (isFreeTrial && !canStartQuizInArea(area || 'desenvolvimento-web') ? 'Sem tentativas' : 'Refazer Quiz') }}
        </button>
        
        <button class="btn btn-secondary" 
                (click)="goHome()"
                [disabled]="isNavigating">
          <i class="fas" 
             [class.fa-home]="!isNavigating"
             [class.fa-spinner]="isNavigating"
             [class.fa-spin]="isNavigating"></i>
          {{ isNavigating ? 'Carregando...' : 'Voltar ao Início' }}
        </button>
        
        <button class="btn btn-success" 
                *ngIf="isFreeTrial && hasExhaustedTrialAttempts()"
                (click)="navigateToUpgrade()"
                [disabled]="isNavigating">
          <i class="fas fa-crown"></i>
          Upgrade para Premium
        </button>
      </div>
    </div>
  </div>

  <!-- ✅ MANTER APENAS ESTA VERSÃO MELHORADA: -->
  <div class="quiz-shortcuts" 
       *ngIf="!showExplanation && currentQuestion && !isPaused"
       (keydown)="handleKeyboardShortcut($event)"
       tabindex="-1"
       [attr.aria-hidden]="true"
       style="position: absolute; left: -9999px; opacity: 0;">
    <!-- Hidden element for keyboard shortcuts -->
  </div>

  <!-- ✅ CORRIGIR OS IDs DO ÁUDIO: -->
  <div class="audio-controls" *ngIf="currentQuestion">
    <button mat-icon-button 
            (click)="toggleSound()"
            [title]="soundEnabled ? 'Desativar sons' : 'Ativar sons'">
      <mat-icon>{{ soundEnabled ? 'volume_up' : 'volume_off' }}</mat-icon>
    </button>
    
    <!-- ✅ ÁUDIO COM IDs CORRETOS -->
    <audio id="correctSound" preload="none" *ngIf="soundEnabled">
      <source src="assets/sounds/correct.mp3" type="audio/mpeg">
      <source src="assets/sounds/correct.ogg" type="audio/ogg">
    </audio>
    <audio id="incorrectSound" preload="none" *ngIf="soundEnabled">
      <source src="assets/sounds/incorrect.mp3" type="audio/mpeg">
      <source src="assets/sounds/incorrect.ogg" type="audio/ogg">
    </audio>
  </div>
</div>

