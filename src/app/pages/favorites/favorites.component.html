<div class="favorites-container">

  <!-- ‚úÖ LOADING STATE -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <h3>Carregando seus favoritos...</h3>
    <p>Organizando suas quest√µes preferidas</p>
  </div>

  <!-- ‚úÖ ERROR STATE -->
  <div *ngIf="hasError" class="error-container">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <h2 class="error-title">Ops! Algo deu errado</h2>
    <p class="error-message">{{ errorMessage }}</p>
    <button mat-raised-button color="primary" (click)="reloadData()">
      <mat-icon>refresh</mat-icon>
      Tentar Novamente
    </button>
  </div>

  <!-- ‚úÖ MAIN CONTENT -->
  <div *ngIf="!isLoading && !hasError">

    <!-- ‚≠ê HEADER SECTION -->
    <header class="favorites-header">
      <div class="header-content">
        <div class="header-text">
          <h1 class="page-title">‚≠ê Meus Favoritos</h1>
          <p class="page-subtitle">Suas quest√µes marcadas como favoritas organizadas em um s√≥ lugar</p>
          <p class="last-updated">
            <mat-icon>update</mat-icon>
            Atualizado: {{ favoritesData.lastUpdated | date:'dd/MM/yyyy HH:mm' }}
          </p>
        </div>
        <div class="header-actions">
          <button mat-stroked-button (click)="navigateToDashboard()">
            <mat-icon>dashboard</mat-icon>
            Dashboard
          </button>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="startFavoritesQuiz()"
            [disabled]="favorites.length === 0"
          >
            <mat-icon>play_arrow</mat-icon>
            Quiz Favoritos
          </button>
        </div>
      </div>
    </header>

    <!-- üìä FAVORITES STATS -->
    <section class="favorites-stats-section">
      <h2 class="section-title">Estat√≠sticas dos Favoritos</h2>
      
      <div class="stats-grid">
        <div class="stat-card total-card">
          <div class="stat-icon">
            <mat-icon>favorite</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-number">{{ favoritesData.totalFavorites }}</span>
            <span class="stat-label">Total de Favoritos</span>
            <span class="stat-sublabel">quest√µes salvas</span>
          </div>
        </div>

        <div class="stat-card quiz-card">
          <div class="stat-icon">
            <mat-icon>school</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-number">{{ getDifficultyCount('F√°cil') }}</span>
            <span class="stat-label">N√≠vel F√°cil</span>
            <span class="stat-sublabel">quest√µes</span>
          </div>
        </div>

        <div class="stat-card removed-card">
          <div class="stat-icon">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-number">{{ getDifficultyCount('Dif√≠cil') }}</span>
            <span class="stat-label">N√≠vel Dif√≠cil</span>
            <span class="stat-sublabel">quest√µes</span>
          </div>
        </div>
      </div>
    </section>

    <!-- üìä AREA DISTRIBUTION -->
    <section class="distribution-section" *ngIf="hasAnyAreas()">
      <h2 class="section-title">Distribui√ß√£o por √Årea</h2>
      
      <div class="area-chips-container">
        <mat-chip-set>
          <mat-chip 
            *ngFor="let area of getAreaKeys()" 
            (click)="setSelectedArea(area)"
            [class.selected]="selectedArea === area"
          >
            {{ getAreaDisplayName(area) }} ({{ getAreaCount(area) }})
          </mat-chip>
        </mat-chip-set>
      </div>

      <div class="quick-area-actions">
        <button 
          *ngFor="let area of getAreaKeys()" 
          mat-stroked-button 
          (click)="startAreaQuiz(getAreaDisplayName(area))"
          class="area-quiz-btn"
        >
          <mat-icon>play_arrow</mat-icon>
          Quiz {{ getAreaDisplayName(area) }}
        </button>
      </div>
    </section>

    <!-- üîç FILTERS & SEARCH -->
    <section class="filters-section">
      <div class="filters-content">
        
        <!-- Busca -->
        <div class="search-group">
          <mat-icon class="search-icon">search</mat-icon>
          <input 
            type="text" 
            placeholder="Buscar quest√µes favoritas..." 
            [(ngModel)]="searchQuery"
            class="search-input"
          >
        </div>

        <!-- Filtros -->
        <div class="filters-group">
          <h3>Dificuldade:</h3>
          <div class="filter-buttons">
            <button 
              mat-stroked-button 
              [color]="filterBy === 'all' ? 'primary' : ''"
              (click)="setFilterBy('all')"
            >
              Todas ({{ favorites.length }})
            </button>
            <button 
              mat-stroked-button 
              [color]="filterBy === 'easy' ? 'primary' : ''"
              (click)="setFilterBy('easy')"
            >
              <mat-icon>trending_down</mat-icon>
              F√°cil ({{ getDifficultyCount('F√°cil') }})
            </button>
            <button 
              mat-stroked-button 
              [color]="filterBy === 'medium' ? 'primary' : ''"
              (click)="setFilterBy('medium')"
            >
              <mat-icon>trending_flat</mat-icon>
              M√©dio ({{ getDifficultyCount('M√©dio') }})
            </button>
            <button 
              mat-stroked-button 
              [color]="filterBy === 'hard' ? 'primary' : ''"
              (click)="setFilterBy('hard')"
            >
              <mat-icon>trending_up</mat-icon>
              Dif√≠cil ({{ getDifficultyCount('Dif√≠cil') }})
            </button>
          </div>
        </div>

        <!-- √Årea e Ordena√ß√£o -->
        <div class="controls-group">
          <div class="area-select">
            <mat-select [(value)]="selectedArea" (selectionChange)="setSelectedArea($event.value)">
              <mat-option value="all">Todas as √Åreas</mat-option>
              <mat-option *ngFor="let area of availableAreas" [value]="area">
                {{ area }}
              </mat-option>
            </mat-select>
          </div>

          <div class="sort-select">
            <mat-select [(value)]="sortBy" (selectionChange)="setSortBy($event.value)">
              <mat-option value="recent">Mais Recentes</mat-option>
              <mat-option value="area">Por √Årea</mat-option>
              <mat-option value="difficulty">Por Dificuldade</mat-option>
              <mat-option value="attempts">Mais Tentativas</mat-option>
            </mat-select>
          </div>
        </div>

      </div>
    </section>

    <!-- üìù FAVORITES LIST -->
    <section class="favorites-list-section">
      <div class="section-header">
        <h2 class="section-title">
          Quest√µes Favoritas
          <span class="count-badge">({{ filteredAndSortedFavorites.length }})</span>
        </h2>
        
        <div class="list-actions" *ngIf="filteredAndSortedFavorites.length > 0">
          <button mat-stroked-button (click)="startFavoritesQuiz()">
            <mat-icon>play_arrow</mat-icon>
            Quiz com Filtradas
          </button>
          <button mat-raised-button color="primary" (click)="navigateToUpgrade()">
            <mat-icon>star</mat-icon>
            Upgrade Premium
          </button>
        </div>
      </div>
      
      <!-- Lista de Quest√µes -->
      <div class="favorites-grid">
        <div 
          *ngFor="let favorite of filteredAndSortedFavorites; trackBy: trackFavorite" 
          class="favorite-card"
          [class.correct-attempt]="favorite.isCorrect === true"
          [class.incorrect-attempt]="favorite.isCorrect === false"
        >
          
          <!-- üìã QUESTION HEADER (Compacto) -->
          <div style="display: flex; align-items: center; gap: 1rem; width: 100%;">
            
            <!-- Meta Info -->
            <div class="question-meta">
              <div class="area-info">
                <span class="area-icon">{{ favorite.icon }}</span>
                <span class="area-name">{{ favorite.areaDisplayName }}</span>
              </div>
              <div class="difficulty-badge" [style.color]="getDifficultyColor(favorite.difficulty)">
                <mat-icon>{{ getDifficultyIcon(favorite.difficulty) }}</mat-icon>
                {{ favorite.difficulty }}
              </div>
            </div>

            <!-- üìù QUESTION CONTENT -->
            <div class="question-content">
              <h3 class="question-text">{{ favorite.question }}</h3>
            </div>

            <!-- üìä QUESTION STATS -->
            <div class="question-stats">
              <div class="stat-item">
                <mat-icon>schedule</mat-icon>
                <span class="stat-value">{{ favorite.addedDate | date:'dd/MM/yyyy' }}</span>
              </div>
              
              <div class="stat-item">
                <mat-icon>bookmark</mat-icon>
                <span class="stat-value">{{ favorite.subject }}</span>
              </div>
            </div>

            <!-- üéØ CARD ACTIONS -->
            <div class="card-actions">
              <button 
                mat-stroked-button 
                (click)="viewQuestion(favorite)"
                class="view-btn"
              >
                <mat-icon>visibility</mat-icon>
                Ver
              </button>
              
              <button 
                mat-raised-button 
                color="primary" 
                (click)="viewQuestion(favorite)"
              >
                <mat-icon>play_arrow</mat-icon>
                Praticar
              </button>

              <button 
                mat-icon-button 
                matTooltip="Remover dos favoritos"
                (click)="removeFavorite(favorite.id)"
                class="remove-btn"
              >
                <mat-icon>favorite</mat-icon>
              </button>
            </div>

          </div>

        </div>
      </div>

      <!-- üìã EMPTY STATE -->
      <div *ngIf="filteredAndSortedFavorites.length === 0" class="empty-state">
        <div *ngIf="favorites.length === 0; else filteredEmpty">
          <mat-icon>favorite_border</mat-icon>
          <h3>Nenhuma quest√£o favorita ainda</h3>
          <p>Comece a marcar quest√µes como favoritas durante os quizzes!</p>
          <button mat-raised-button color="primary" (click)="navigateToDashboard()">
            <mat-icon>dashboard</mat-icon>
            Ir para Dashboard
          </button>
        </div>
        
        <ng-template #filteredEmpty>
          <mat-icon>search_off</mat-icon>
          <h3>Nenhuma quest√£o encontrada</h3>
          <p>Tente ajustar os filtros ou termo de busca</p>
          <button mat-stroked-button (click)="setFilterBy('all'); setSelectedArea('all'); searchQuery = ''">
            <mat-icon>clear</mat-icon>
            Limpar Filtros
          </button>
        </ng-template>
      </div>
    </section>

    <!-- üéØ PREMIUM UPGRADE SECTION -->
    <section class="upgrade-section" *ngIf="favorites.length > 0">
      <div class="upgrade-card">
        <div class="upgrade-content">
          <div class="upgrade-icon">
            <mat-icon>star</mat-icon>
          </div>
          <div class="upgrade-text">
            <h3>Upgrade para Premium</h3>
            <p>Favoritos ilimitados, relat√≥rios detalhados e muito mais!</p>
          </div>
          <div class="upgrade-action">
            <button mat-raised-button color="primary" (click)="navigateToUpgrade()">
              Fazer Upgrade
            </button>
          </div>
        </div>
      </div>
    </section>

  </div>
</div>
